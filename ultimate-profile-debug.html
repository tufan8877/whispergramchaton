<!DOCTYPE html>
<html>
<head>
    <title>Ultimate Badge Debug</title>
    <style>
        body { font-family: monospace; background: #000; color: #0f0; padding: 20px; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>ULTIMATE BADGE DEBUG - FINDET DEN ECHTEN FEHLER</h1>
    <div id="status"></div>
    <div id="results"></div>
    
    <script>
        let testCount = 0;
        
        async function ultimateDebug() {
            testCount++;
            const status = document.getElementById('status');
            const results = document.getElementById('results');
            
            status.innerHTML = `<div class="warning">TEST ${testCount} LÄUFT...</div>`;
            
            try {
                // 1. Backend API Test
                console.log('=== BACKEND API TEST ===');
                const apiResponse = await fetch('/api/chats/7');
                const apiData = await apiResponse.json();
                
                if (apiData && apiData.length > 0) {
                    const chat = apiData[0];
                    const backendUnread = chat.unreadCount2 || 0;
                    
                    results.innerHTML += `<div class="success">BACKEND: unreadCount2 = ${backendUnread}</div>`;
                    console.log('Backend unreadCount2:', backendUnread);
                    
                    if (backendUnread > 1) {
                        results.innerHTML += `<div class="success">✓ Backend hat Nachrichten (${backendUnread})</div>`;
                    } else {
                        results.innerHTML += `<div class="error">✗ Backend hat keine ungelesenen Nachrichten</div>`;
                        return;
                    }
                } else {
                    results.innerHTML += `<div class="error">✗ Backend API liefert keine Daten</div>`;
                    return;
                }
                
                // 2. Login Status Check
                console.log('=== LOGIN STATUS CHECK ===');
                const userSession = localStorage.getItem('userSession');
                if (userSession) {
                    const user = JSON.parse(userSession);
                    results.innerHTML += `<div class="success">LOGIN: User ${user.username} (ID: ${user.id})</div>`;
                    
                    if (user.id === 7) {
                        results.innerHTML += `<div class="success">✓ Korrekte User ID für Badge Test</div>`;
                    } else {
                        results.innerHTML += `<div class="error">✗ Falsche User ID: ${user.id} (sollte 7 sein)</div>`;
                    }
                } else {
                    results.innerHTML += `<div class="error">✗ Nicht eingeloggt</div>`;
                    return;
                }
                
                // 3. React Component Check
                console.log('=== REACT COMPONENT CHECK ===');
                const chatElements = document.querySelectorAll('[class*="chat"]');
                const badgeElements = document.querySelectorAll('[class*="bg-green-500"]');
                
                results.innerHTML += `<div>GEFUNDEN: ${chatElements.length} Chat-Elemente, ${badgeElements.length} Badge-Elemente</div>`;
                
                if (badgeElements.length > 0) {
                    for (let badge of badgeElements) {
                        const badgeText = badge.textContent || '';
                        results.innerHTML += `<div class="warning">BADGE ZEIGT: "${badgeText}"</div>`;
                        console.log('Badge text:', badgeText);
                        
                        if (badgeText === '1') {
                            results.innerHTML += `<div class="error">✗ PROBLEM GEFUNDEN: Badge zeigt "1" statt Backend-Wert</div>`;
                        } else if (parseInt(badgeText) > 1) {
                            results.innerHTML += `<div class="success">✓ Badge zeigt korrekte Zahl: ${badgeText}</div>`;
                        }
                    }
                } else {
                    results.innerHTML += `<div class="error">✗ Keine Badges gefunden im DOM</div>`;
                }
                
                // 4. Console Logs Check
                console.log('=== CONSOLE LOGS CHECK ===');
                results.innerHTML += `<div class="warning">Prüfen Sie Browser Console für "DIRECT BADGE" Logs</div>`;
                
                status.innerHTML = `<div class="success">TEST ${testCount} ABGESCHLOSSEN</div>`;
                
            } catch (error) {
                results.innerHTML += `<div class="error">FEHLER: ${error.message}</div>`;
                console.error('Debug error:', error);
            }
        }
        
        // Test sofort und alle 3 Sekunden
        ultimateDebug();
        setInterval(ultimateDebug, 3000);
    </script>
</body>
</html>